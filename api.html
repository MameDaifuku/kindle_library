<script>

  /* ★★★★★★★★★★★★★★★更新系★★★★★★★★★★★★★★ */

  function updateStatusTag(titlePronunciationSeries, statusTag) {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(function(){
          resolve();
        })
        .withFailureHandler(function(){
          reject();
        })
        .updateStatusTag([titlePronunciationSeries, statusTag]);
    });
  }

  /* xmlファイル選択時の処理 */
  function upsertFromXmlFile(inputElement) {
    let fileReader = new FileReader();
    fileReader.onload = function(e) {
      //おまじない
      'use strict';

      const parser = new DOMParser();
      const doc = parser.parseFromString(e.target.result, "text/xml");
      let targetArray = [];
      for (let book of doc.getElementsByTagName("meta_data")) {
        if (!ASINData.includes(book.getElementsByTagName("ASIN")[0].textContent)) {
          
          //authorを直列化
          let authors = "";
          let authorsPronunciation = "";
          for (let author of book.getElementsByTagName("author")) {
            authors += author.textContent;
            authors += ";";
            authorsPronunciation += author.getAttribute("pronunciation");
            authorsPronunciation += ";";
          }

          //publisherを直列化
          let publishers = "";
          for (let publisher of book.getElementsByTagName("publisher")) {
            publishers += publisher.textContent;
            publishers += ";";
          }

          //originを直列化
          let origins = "";
          for (let origin of book.getElementsByTagName("origin")) {
            origins += origin.textContent;
            origins += ";";
          }

          let target = [
            book.getElementsByTagName("ASIN")[0].textContent,
            book.getElementsByTagName("title")[0].textContent,
            book.getElementsByTagName("title")[0].getAttribute("pronunciation"),
            book.getElementsByTagName("title")[0].getAttribute("pronunciation").split("0")[0],
            authors,
            authorsPronunciation,
            book.getElementsByTagName("publication_date")[0].textContent,
            book.getElementsByTagName("purchase_date")[0].textContent,
            "", //STATUS_TAG //"NONE"とかセットしてはいけない。
            publishers,
            book.getElementsByTagName("textbook_type")[0].textContent,
            book.getElementsByTagName("cde_contenttype")[0].textContent,
            book.getElementsByTagName("content_type")[0].textContent,
            origins,
          ]
          targetArray.push(target);
        }
      }

      console.log("xmlのループ終了");
      google.script.run
        .withSuccessHandler(function(val){
          /* 正常系 */
          alert("正常終了：" + val);
        })
        .withFailureHandler(function(val){
          /* 異常系 */
          alert("異常終了：" + val);
        })
        .insertKindleBooks(targetArray); //insert対象のレコード情報を配列でそのまま渡す。サーバー側は配列としてそのまま処理できる。
    };

    // ファイルの読み込み(単一ファイル選択、テキストファイルを前提とする)
    if (inputElement.files[0]) {
      fileReader.readAsText(inputElement.files[0]);
    }
  }

  /* ★★★★★★★★★★★★★★★取得系★★★★★★★★★★★★★★ */

  /* ASINだけ取得 */
  async function getASINData() {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(function(val){
          /* 正常系 */
          ASINData = val;
          console.log("getASINData done.");
          resolve();
        })
        .withFailureHandler(function(val){
          /* 異常系 */
          alert("異常終了：" + val);
          reject();
        })
        .getASINData();    
    });
  }

  /* シリーズ集計用の情報だけ取得 */
  async function getTitlePronunciationSeriesData() {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(function(val){
          /* 正常系 */
          titlePronunciationSeriesData = val;
          console.log("getTitlePronunciationSeriesData done.");
          resolve();
        })
        .withFailureHandler(function(val){
          /* 異常系 */
          alert("異常終了：" + val);
          reject();
        })
        .getTitlePronunciationSeriesData();     
    });
  }

  /* スプシのデータを一括取得 */
  async function getAllData() {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(function(val){
          /* 正常系 */
          allData = val;
          console.log("getAllData done.");
          resolve();
        })
        .withFailureHandler(function(val){
          /* 異常系 */
          alert("異常終了：" + val);
          reject();
        })
        .getAllData();        
    });
  }
</script>