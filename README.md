# 概要
kindleアプリが気に入らないので自作した。  
具体的に気に入らないポイントは以下。  

```  
・もう読まないよなーってなった本を非表示にできない。  
・購入日順でソートできない。  
・状態を設定できない。  
　（本単位ならコレクションでできるけどシリーズ単位だとできない）  
```

# 導入方法
①Googleドライブでスプレッドシートを新規作成（ファイル名は任意）  
②スプレッドシート内のシート名を「BOOKS」に変更
③スプレッドシートをブラウザで開く  
④スプレッドシートのURLは以下のような感じになっているはず。  
　https://docs.google.com/spreadsheets/d/[スプレッドシートのID]/edit?~~~  
⑤コード.gsの先頭のSPREAD_SHEET_IDに↑のURLの値をコピペ  
⑥GoogleドライブでAppScriptを新規作成（ファイル名は任意）  
⑦AppScriptプロジェクトでHTMLファイルを作成（ファイル名はリポジトリのファイル名に合わせる）  
⑧ファイルの中身を一通りコピペ  
　（\_js_test.htmlは検証用実装なので不要）  
⑨AppScriptプロジェクトでデプロイを実行  
　種類の選択：ウェブアプリ  
　次のユーザー都市て実行：自分  
　アクセスできるユーザー：自分のみ  
⑩デプロイ後に表示されるURLをブラウザで開く  

# 使い方（※PCでkindleアプリがインストールされていることを前提とする）
## 初回起動時
①kindleアプリを開く  
　（開いた際に本の一覧情報がローカルに保存される）  
②kindleアプリを閉じる  
③AppScriptのURLを開く  
④画面左上の「ファイルを選択」ボタンを押下  
⑤ファイルダイアログで以下を開く  
　C:\Users\[ユーザー名]\AppData\Local\Amazon\Kindle\Cache  
⑥KindleSyncMetadataCache.xmlを選択、処理完了ポップアップが表示されるまで待機  
⑦スプレッドシートを開き、所有している本の情報が保存されていることを確認  
⑧AppScriptのURLを再度開く  
　＞一覧表示される  

## 運用時
### 表示する
・画面にはシリーズ単位で表示される。  
・画像をクリックするとシリーズの本一覧が表示される。  
・購入日順 / 出版日順 を変更すると並び順が変わる。  
・未設定等のチェックボックス（STATUS_TAG）を変更すると表示対象が絞り込まれる。  
・タイトル検索に値を入力すると表示対象が絞り込まれる。  
　タイトル、タイトル読み仮名（カタカナ）によって絞り込まれる。  

### 読む
・本一覧で画像をクリックするとブラウザリーダーに遷移する。  

### 編集する
・画面左上の編集モードにチェックをつけるとシリーズ一覧の画像の下に  
　STATUS_TAGプルダウンが表示される。  
・プルダウンを変更するとスプレッドシートのSTATUS_TAGの値が変更される。  
・プルダウンを変更しても画面表示は（意図的に）同期させていない。  
　AppScriptのURLを開きなおしたタイミングで同期することになる。  

# 注意点
・kindleのxml内に保持している情報にはちょいちょい不備がある。  
　必要に応じてスプレッドシート内の値を手動メンテする必要がある。以下具体例。  
  
　- publication_dateが空白になっている。  
　- 同じタイトルの本でも読み仮名（title_pronunciation）の表記揺れがある。  
　　（「アドベンチャー」と「アドヴェンチャー」、等）  
　- コミカライズ作品の場合に原作者やキャラクター原案の名前がauthorsに含まれていないパターンがある。  
  
・シリーズ単位の集約は「title_pronunciation_series」を使って行っている。  
　この「title_pronunciation_series」はxml内に保持している項目ではなく  
　「title_pronunciation」を使ってロジック内で生成している。  
　具体的には「0」でsplitした配列の先頭要素を「title_pronunciation_series」として格納している。  
　しかしモノによってはこれが正常に機能しないパターンがある。  
  
　例えば「幼女戦記10巻」のtitle_pronunciationは「ヨウジョセンキ010」なので機能する。  
　（3桁ゼロサプレス）  
　例えば「売国機関10巻」のtitle_pronunciationは「バイコクキカン10」なので機能しない。  
　（2桁ゼロサプレス）  
　例えば「ONE PIECE モノクロ版 100」のtitle_pronunciationは「ワンピースモノクロバン100」なので機能しない。  
　（3桁ゼロサプレスだけど3桁目を使ってしまったのでもうダメ）  
  
　手元にサンプルが無かったけどたぶんゼロサプレスされてないというパターンもある。  
　ともあれ、手動メンテしなくても済むようにもう少しなんとかしたいところではある。  
　正規表現で数字を全部0に置き換えてから処理してみるとか？  
  
・kindleインディーズマンガの場合、titleとtitle_pronunciationがかなり無茶苦茶になっている。  
　「title_pronunciation_series」を手動メンテしないとシリーズ集約が機能しない。  
  
# TODO
・画像サイズを揃えてるせいで画像が縦長になってる。imgをdivでラップしてdivのサイズで調整するようにしたい。  
・ソート順もlocalStrageにキャッシュできるようにしたい。  
・絞り込みロジックを最適化したい。  
・title_pronunciation_series生成時の数値を正規表現で処理するヤツの検証。  
・publication_dateでsortしてる箇所、日付がまったく同じヤツが存在する場合に並び順が一貫しないので  
　タイトル昇順もsort条件に含める。  
・本一覧画面から作家検索に移行できるような動線が欲しい。ストアページの下あたりにリンクを追加する感じにするか。  
　ライブラリ内検索もやりたいけどAmazon検索に飛ばすリンクもほしい。  
・メンテ作業用にタイトル順ソートを実装したい。  
・iPad miniで開くとレイアウトが崩れるので最適化したい。  